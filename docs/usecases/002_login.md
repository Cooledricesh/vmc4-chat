# Usecase 002: 로그인

**문서 번호:** UC-002
**기능명:** 로그인
**작성일:** 2025-10-19
**관련 유저플로우:** 2. 로그인 유저플로우

---

## 1. 개요

사용자가 이메일과 비밀번호를 입력하여 Cokaotalk에 로그인하는 기능입니다. 인증 성공 시 JWT 토큰을 발급받아 메인 페이지로 이동합니다.

---

## 2. 사전 조건

- 사용자가 회원가입을 완료하여 users 테이블에 계정이 존재해야 합니다.
- 로그인 페이지(/login)에 접근할 수 있어야 합니다.
- JWT 토큰 생성 및 HTTP-only 쿠키 설정이 가능해야 합니다.

---

## 3. 액터

- **주 액터:** 등록된 사용자
- **부 액터:** Cokaotalk 백엔드 시스템, 데이터베이스, JWT 토큰 발급 시스템

---

## 4. 기본 시나리오 (정상 흐름)

### 4.1. 로그인 페이지 진입
1. 사용자가 Cokaotalk 메인 URL 접속 또는 로그인 페이지(/login)로 직접 이동합니다.
2. 비로그인 상태에서 보호된 페이지 접근 시 자동으로 로그인 페이지로 리디렉션됩니다.

### 4.2. 인증 정보 입력
3. 사용자가 다음 정보를 입력합니다:
   - 이메일 주소
   - 비밀번호

### 4.3. 클라이언트 기본 검증
4. 시스템이 입력값을 검증합니다:
   - 이메일 형식 확인 (간단한 @ 포함 여부)
   - 비밀번호 입력 여부 확인

### 4.4. 로그인 요청
5. 사용자가 "로그인" 버튼을 클릭합니다.
6. 시스템이 로그인 버튼을 비활성화하여 중복 제출을 방지합니다.

### 4.5. 서버 인증 처리
7. 서버가 다음을 수행합니다:
   - users 테이블에서 이메일로 사용자 조회:
     ```sql
     SELECT id, email, nickname, password_hash
     FROM users
     WHERE email = $1;
     ```
   - bcrypt.compare()로 입력 비밀번호와 저장된 해시 비교
   - 인증 성공 시 JWT 페이로드 생성:
     ```json
     {
       "userId": "550e8400-e29b-41d4-a716-446655440000",
       "email": "user@example.com",
       "nickname": "사용자닉네임",
       "iat": 1697712000,
       "exp": 1697798400
     }
     ```
   - JWT 토큰 서명 및 생성

### 4.6. 토큰 저장 및 응답
8. 서버가 HTTP-only 쿠키에 JWT 토큰을 설정합니다:
   ```
   Set-Cookie: auth_token=<JWT>; HttpOnly; Secure; SameSite=Strict; Max-Age=86400
   ```
9. 성공 응답을 클라이언트에 반환합니다.

### 4.7. 클라이언트 상태 업데이트
10. 클라이언트가 사용자 정보를 전역 상태(Zustand)에 저장합니다.
11. React Query 캐시를 초기화합니다.

### 4.8. 페이지 리디렉션
12. 시스템이 메인 페이지(/)로 자동 리디렉션합니다.
13. 헤더에 사용자 닉네임과 마이페이지 링크가 표시됩니다.

---

## 5. 대체 시나리오 (예외 상황)

### 5.1. 이메일 미입력
- **조건:** 이메일 필드가 비어있음
- **결과:** "이메일을 입력해주세요" 오류 메시지 표시
- **복구:** 사용자가 이메일 입력 후 재시도

### 5.2. 비밀번호 미입력
- **조건:** 비밀번호 필드가 비어있음
- **결과:** "비밀번호를 입력해주세요" 오류 메시지 표시
- **복구:** 사용자가 비밀번호 입력 후 재시도

### 5.3. 계정 미존재
- **조건:** 입력한 이메일이 users 테이블에 없음
- **결과:**
  - HTTP 401 Unauthorized 응답
  - "이메일 혹은 비밀번호를 확인해주세요" 메시지 표시 (보안상 구체적 정보 제공 안 함)
- **복구:** 사용자가 이메일 재확인 또는 회원가입 진행

### 5.4. 비밀번호 불일치
- **조건:** bcrypt.compare() 결과가 false
- **결과:**
  - HTTP 401 Unauthorized 응답
  - "이메일 혹은 비밀번호를 확인해주세요" 메시지 표시
- **복구:** 사용자가 비밀번호 재입력 또는 비밀번호 찾기 (MVP 범위 외)

### 5.5. 이미 로그인된 상태
- **조건:** 유효한 JWT 토큰이 쿠키에 존재
- **결과:** 로그인 페이지 접근 시 자동으로 메인 페이지로 리디렉션
- **동작:** 로그인 폼을 표시하지 않음

### 5.6. 토큰 만료 후 로그인
- **조건:** 만료된 JWT 토큰으로 페이지 접근 시도
- **결과:**
  - "세션이 만료되었습니다. 다시 로그인해주세요" 메시지 표시
  - 로그인 페이지로 리디렉션
- **복구:** 사용자가 재로그인

### 5.7. 네트워크 오류
- **조건:** 로그인 요청 중 네트워크 연결 끊김
- **결과:**
  - 로딩 스피너 표시 후 타임아웃 (30초)
  - "네트워크 연결을 확인해주세요" 오류 메시지 표시
  - 로그인 버튼 재활성화
- **복구:** 사용자가 네트워크 확인 후 재시도

### 5.8. 서버 오류
- **조건:** 데이터베이스 연결 실패 또는 내부 서버 오류
- **결과:**
  - HTTP 500 Internal Server Error 응답
  - "일시적인 오류가 발생했습니다. 잠시 후 다시 시도해주세요" 메시지 표시
  - 로그인 버튼 재활성화
- **복구:** 사용자가 잠시 후 재시도

### 5.9. 연속 로그인 실패 (옵션)
- **조건:** 동일 IP에서 5회 이상 로그인 실패
- **결과:**
  - "로그인 시도 횟수를 초과했습니다. 5분 후 다시 시도해주세요" 메시지 표시
  - 해당 IP를 5분간 차단 (Redis 또는 메모리 캐시 활용)
- **복구:** 5분 후 자동 해제

### 5.10. CSRF 공격 시도
- **조건:** CSRF 토큰이 없거나 유효하지 않음
- **결과:**
  - HTTP 403 Forbidden 응답
  - "잘못된 요청입니다" 오류 메시지
- **보안:** CSRF 토큰 검증 미들웨어 적용

---

## 6. 사후 조건

### 성공 시
- JWT 토큰이 HTTP-only 쿠키에 저장됩니다.
- 사용자 정보가 전역 상태에 저장됩니다.
- 메인 페이지(/)로 리디렉션됩니다.
- 모든 보호된 페이지에 접근할 수 있습니다.

### 실패 시
- 쿠키에 어떠한 토큰도 저장되지 않습니다.
- 사용자는 로그인 페이지에 그대로 유지됩니다.
- 입력한 이메일은 유지되나 비밀번호는 초기화됩니다.

---

## 7. 비기능적 요구사항

### 7.1. 성능
- 로그인 처리 시간: 1초 이내
- bcrypt 비교 연산: 500ms 이내

### 7.2. 보안
- 비밀번호는 HTTPS를 통해서만 전송
- JWT 토큰은 HTTP-only, Secure, SameSite=Strict 속성 적용
- 토큰 만료 시간: 24시간
- Refresh Token은 MVP 범위 외 (추후 구현 고려)
- 로그인 실패 시 구체적인 실패 사유를 노출하지 않음 (계정 존재 여부 숨김)

### 7.3. 접근성
- 모든 입력 필드에 적절한 label 연결
- 오류 메시지는 스크린 리더가 읽을 수 있도록 aria-live 영역에 표시
- 키보드만으로 모든 기능 접근 가능 (Tab, Enter)

### 7.4. 사용성
- 비밀번호 표시/숨김 토글 버튼 제공
- 이메일 자동완성 지원 (autocomplete="email")
- Enter 키로 로그인 가능

---

## 8. UI/UX 요구사항

### 8.1. 레이아웃
- 중앙 정렬된 로그인 폼 (최대 너비 400px)
- 모바일 반응형 디자인 (320px 이상 지원)

### 8.2. 입력 필드
- **이메일:**
  - type="email"
  - placeholder="이메일 주소"
  - autocomplete="email"
- **비밀번호:**
  - type="password"
  - placeholder="비밀번호"
  - autocomplete="current-password"
  - 표시/숨김 토글 아이콘

### 8.3. 버튼
- **로그인 버튼:**
  - 기본 상태: 활성화, 파란색 배경
  - 비활성 상태: 회색 배경, 커서 not-allowed
  - 로딩 상태: 스피너 표시, "로그인 중..." 텍스트

### 8.4. 추가 링크
- "회원가입" 링크: 하단에 표시, 회원가입 페이지로 이동
- "비밀번호 찾기" 링크: 하단에 표시 (MVP 범위 외, 비활성화)

### 8.5. 오류 표시
- 오류 메시지 색상: 빨간색 (#DC2626)
- 폼 상단에 오류 메시지 박스 표시
- 아이콘: 느낌표 또는 X 아이콘

### 8.6. 성공 표시
- 로그인 성공 시: 간단한 "로그인 중..." 메시지 후 즉시 리디렉션
- 불필요한 대기 시간 없이 빠른 전환

---

## 9. 데이터베이스 영향

### 조회되는 레코드
```sql
-- users 테이블에서 SELECT
SELECT
  id,
  email,
  nickname,
  password_hash
FROM users
WHERE email = 'user@example.com';
```

### 인덱스 활용
- `idx_users_email`: 이메일 기반 사용자 조회 최적화

### 데이터 변경 없음
- 로그인은 READ 작업만 수행하며 데이터베이스 변경 없음
- 로그인 로그 기록은 MVP 범위 외 (추후 구현 고려)

---

## 10. API 명세

### Endpoint
```
POST /api/auth/login
```

### Request Body
```json
{
  "email": "user@example.com",
  "password": "securepassword123"
}
```

### Response (성공)
```json
{
  "success": true,
  "message": "로그인 성공",
  "data": {
    "user": {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "email": "user@example.com",
      "nickname": "사용자닉네임"
    }
  }
}
```

### Response Header (성공)
```
Set-Cookie: auth_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...; HttpOnly; Secure; SameSite=Strict; Max-Age=86400; Path=/
```

### Response (실패 - 인증 실패)
```json
{
  "success": false,
  "error": {
    "code": "INVALID_CREDENTIALS",
    "message": "이메일 혹은 비밀번호를 확인해주세요"
  }
}
```

---

## 11. 상태 관리

### 전역 상태 (Zustand)
```typescript
interface AuthState {
  user: {
    id: string;
    email: string;
    nickname: string;
  } | null;
  isAuthenticated: boolean;
  login: (user: User) => void;
  logout: () => void;
}
```

### React Query 캐시
- 로그인 성공 시 모든 쿼리 캐시 무효화
- 사용자 정보는 쿼리 키 `['user', userId]`로 캐싱

---

## 12. 테스트 시나리오

### 12.1. 정상 케이스
- [ ] 유효한 이메일/비밀번호로 로그인 성공
- [ ] 로그인 후 메인 페이지로 리디렉션
- [ ] 헤더에 사용자 닉네임 표시
- [ ] JWT 토큰이 쿠키에 저장됨

### 12.2. 인증 실패
- [ ] 잘못된 이메일 입력 시 오류 메시지
- [ ] 잘못된 비밀번호 입력 시 오류 메시지
- [ ] 미가입 이메일 입력 시 오류 메시지

### 12.3. 유효성 검증
- [ ] 빈 이메일 입력 시 오류 메시지
- [ ] 빈 비밀번호 입력 시 오류 메시지

### 12.4. 세션 관리
- [ ] 이미 로그인된 상태에서 로그인 페이지 접근 시 메인 페이지로 리디렉션
- [ ] 토큰 만료 후 보호된 페이지 접근 시 로그인 페이지로 리디렉션

### 12.5. 보안
- [ ] JWT 토큰이 HTTP-only 쿠키로 저장됨
- [ ] HTTPS를 통해서만 토큰 전송
- [ ] CSRF 토큰 검증

### 12.6. UX
- [ ] Enter 키로 로그인 가능
- [ ] 로딩 중 버튼 비활성화
- [ ] 비밀번호 표시/숨김 토글 동작
- [ ] 네트워크 오류 시 재시도 가능

---

## 13. 관련 문서

- [유저플로우 문서 - 2. 로그인](../userflow.md#2-로그인-유저플로우)
- [데이터베이스 설계 - users 테이블](../database.md#1-users-테이블)
- [PRD - 로그인 기능](../prd.md)
- [Usecase 001 - 회원가입](./001_signup.md)
