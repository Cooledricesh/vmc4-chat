# Usecase 008: 메시지 삭제

**문서 번호:** UC-008
**기능명:** 메시지 삭제
**작성일:** 2025-10-19
**관련 유저플로우:** 8. 메시지 삭제 유저플로우

---

## 1. 개요

사용자가 자신이 작성한 메시지를 삭제하는 기능입니다. Soft delete 방식으로 처리되어 메시지 내용은 보존되며, 모든 사용자 화면에 "삭제된 메시지" 로 표시됩니다. 답장 관계는 유지됩니다.

---

## 2. 사전 조건

- 사용자가 채팅방에 입장한 상태여야 합니다.
- 삭제할 메시지가 자신이 작성한 메시지여야 합니다.
- 메시지가 이미 삭제되지 않은 상태여야 합니다.
- WebSocket 연결이 수립되어 있어야 합니다.

---

## 3. 액터

- **주 액터:** 메시지 작성자
- **부 액터:** Cokaotalk 백엔드 시스템, 데이터베이스, WebSocket 서비스, 다른 참여자

---

## 4. 기본 시나리오 (정상 흐름)

### 4.1. 삭제 버튼 표시
1. 사용자가 자신이 작성한 메시지에 마우스를 올립니다.
2. 메시지 우측 또는 컨텍스트 메뉴에 삭제 버튼이 표시됩니다.
3. 다른 사용자의 메시지에는 삭제 버튼이 표시되지 않습니다.

### 4.2. 삭제 확인 (선택사항)
4. 사용자가 삭제 버튼을 클릭합니다.
5. 확인 다이얼로그가 표시됩니다 (선택사항):
   - "이 메시지를 삭제하시겠습니까?"
   - "취소" 및 "삭제" 버튼

### 4.3. 삭제 요청
6. 사용자가 "삭제" 를 확인합니다.
7. 클라이언트가 권한을 검증합니다:
   - 로그인 상태 확인
   - 메시지 작성자 본인 확인

### 4.4. 낙관적 업데이트
8. 클라이언트가 즉시 UI를 업데이트합니다:
   - 메시지 내용을 "삭제된 메시지" 로 대체
   - 메시지 구조는 유지 (시간, 작성자 표시)
   - 회색 텍스트 및 이탤릭 스타일 적용

### 4.5. 서버 처리
9. 서버가 권한을 재검증합니다:
   - JWT 토큰에서 사용자 ID 추출
   - 메시지 작성자 확인
10. messages 테이블을 업데이트합니다 (Soft delete):
    ```sql
    UPDATE messages
    SET is_deleted = true, updated_at = NOW()
    WHERE id = $1 AND user_id = $2 AND is_deleted = false
    RETURNING *;
    ```

### 4.6. 관련 데이터 처리
11. 답장 관계는 유지됩니다 (parent_message_id 유지).
12. 좋아요 데이터도 유지됩니다 (message_reactions 유지).

### 4.7. WebSocket 브로드캐스트
13. 서버가 모든 참여자에게 삭제 이벤트를 브로드캐스트합니다:
    ```json
    {
      "type": "message_deleted",
      "payload": {
        "messageId": "msg-uuid",
        "roomId": "room-uuid",
        "deletedAt": "2025-10-19T12:00:00Z"
      }
    }
    ```

### 4.8. 다른 참여자 수신
14. 다른 참여자의 화면에서 해당 메시지가 "삭제된 메시지" 로 변경됩니다.
15. 답장이 있는 경우 답장은 유지되며, 원본은 "삭제된 메시지" 로 표시됩니다.

---

## 5. 대체 시나리오 (예외 상황)

### 5.1. 타인 메시지 삭제 시도
- **조건:** 다른 사용자의 메시지 삭제 시도
- **결과:**
  - 삭제 버튼 미표시 (클라이언트)
  - 서버 요청 시 HTTP 403 Forbidden 응답
  - "삭제 권한이 없습니다" 오류 메시지
- **복구:** 불가능 (권한 없음)

### 5.2. 이미 삭제된 메시지
- **조건:** is_deleted가 true인 메시지 재삭제 시도
- **결과:**
  - HTTP 400 Bad Request 응답
  - "이미 삭제된 메시지입니다" 메시지
  - 중복 삭제 방지
- **복구:** 자동 방지

### 5.3. 삭제 중 네트워크 끊김
- **조건:** 삭제 요청 중 네트워크 오류
- **결과:**
  - 낙관적 업데이트 롤백
  - 원래 메시지 내용 복구
  - "삭제에 실패했습니다" 오류 메시지
  - "다시 시도" 버튼 표시
- **복구:** 사용자가 재시도

### 5.4. 답장이 있는 메시지 삭제
- **조건:** 다른 사용자가 답장한 메시지 삭제
- **결과:**
  - 삭제 정상 처리
  - 답장 메시지는 유지
  - 답장의 원본 메시지는 "삭제된 메시지" 로 표시
- **복구:** 정상 동작

### 5.5. 삭제 취소 (MVP 범위 외)
- **조건:** 사용자가 삭제 후 복구 시도
- **결과:** MVP에서는 복구 기능 미지원
- **복구:** 불가능

### 5.6. 서버 오류
- **조건:** 데이터베이스 업데이트 실패
- **결과:**
  - HTTP 500 응답
  - 낙관적 업데이트 롤백
  - "일시적인 오류가 발생했습니다" 메시지
- **복구:** 사용자가 재시도

---

## 6. 사후 조건

### 성공 시
- messages 테이블의 is_deleted 플래그가 true로 설정됩니다.
- 모든 참여자 화면에 "삭제된 메시지" 로 표시됩니다.
- 답장 관계와 좋아요 데이터는 유지됩니다.
- 메시지 구조(시간, 작성자)는 유지됩니다.

### 실패 시
- 데이터베이스에 변경이 없습니다.
- 낙관적 업데이트가 롤백됩니다.
- 사용자에게 오류 메시지가 표시됩니다.

---

## 7. 비기능적 요구사항

### 7.1. 성능
- 삭제 처리 시간: 300ms 이내
- 낙관적 업데이트: 즉시 (0ms)
- WebSocket 브로드캐스트: 100ms 이내

### 7.2. 보안
- 권한 검증 (작성자 본인만 삭제 가능)
- 중복 삭제 방지
- Soft delete로 감사 추적 가능

### 7.3. 데이터 보존
- Soft delete 사용 (물리적 삭제 금지)
- 답장 관계 유지
- 좋아요 데이터 유지

### 7.4. 사용성
- 낙관적 업데이트로 즉각적인 피드백
- 삭제 확인 다이얼로그 (실수 방지)
- 실패 시 롤백 및 재시도 옵션

---

## 8. UI/UX 요구사항

### 8.1. 삭제 버튼
- **위치:** 본인 메시지 우측 또는 컨텍스트 메뉴
- **아이콘:** 휴지통 아이콘
- **조건:** 본인 메시지에만 표시

### 8.2. 확인 다이얼로그
- **제목:** "메시지 삭제"
- **내용:** "이 메시지를 삭제하시겠습니까?"
- **버튼:** "취소" (회색), "삭제" (빨간색)

### 8.3. 삭제된 메시지 표시
- **텍스트:** "삭제된 메시지"
- **스타일:**
  - 회색 텍스트 (#9CA3AF)
  - 이탤릭 폰트
  - 배경색 유지 (본인/타인 구분)
- **구조 유지:**
  - 작성자 닉네임 표시
  - 시간 표시
  - 답장 연결선 유지

### 8.4. 답장 관계 표시
- **삭제된 메시지에 대한 답장:**
  - 원본 메시지: "삭제된 메시지"
  - 답장 메시지: 정상 표시
  - 연결선: 유지

---

## 9. 데이터베이스 영향

### 업데이트되는 레코드
```sql
-- Before
{
  id: "msg-uuid",
  content: "원래 메시지 내용",
  is_deleted: false,
  updated_at: "2025-10-19T12:00:00Z"
}

-- After
{
  id: "msg-uuid",
  content: "원래 메시지 내용", -- 보존됨
  is_deleted: true,
  updated_at: "2025-10-19T12:05:00Z"
}
```

### 유지되는 레코드
- message_reactions: 좋아요 데이터 유지
- messages (답장): parent_message_id 관계 유지

### 인덱스 활용
- `idx_messages_room_id_created_at`: 메시지 목록 조회
- 기본 키(id): 메시지 식별

---

## 10. API 명세

### Endpoint
```
DELETE /api/rooms/:roomId/messages/:messageId
```

### Request Headers
```
Authorization: Bearer <JWT_TOKEN>
```

### Response (성공)
```json
{
  "success": true,
  "data": {
    "messageId": "msg-uuid",
    "deletedAt": "2025-10-19T12:05:00Z"
  }
}
```

### Response (실패 - 권한 없음)
```json
{
  "success": false,
  "error": {
    "code": "FORBIDDEN",
    "message": "삭제 권한이 없습니다"
  }
}
```

### Response (실패 - 이미 삭제됨)
```json
{
  "success": false,
  "error": {
    "code": "ALREADY_DELETED",
    "message": "이미 삭제된 메시지입니다"
  }
}
```

---

## 11. 상태 관리

### Context Actions
```typescript
// 메시지 삭제
actions.deleteMessage(messageId);

// 내부 처리:
// 1. 낙관적 업데이트
dispatch({
  type: 'UPDATE_MESSAGE',
  payload: { id: messageId, updates: { isDeleted: true, content: '삭제된 메시지' } }
});

// 2. API 호출
const response = await apiClient.delete(`/api/rooms/${roomId}/messages/${messageId}`);

// 3. 성공 시 (변경 없음, 이미 낙관적으로 업데이트됨)

// 4. 실패 시 롤백
dispatch({
  type: 'UPDATE_MESSAGE',
  payload: { id: messageId, updates: { isDeleted: false, content: originalContent } }
});
```

---

## 12. 테스트 시나리오

### 12.1. 정상 케이스
- [ ] 본인 메시지 삭제 성공
- [ ] 삭제된 메시지가 "삭제된 메시지" 로 표시
- [ ] 다른 참여자 화면에도 실시간 반영
- [ ] 메시지 구조(시간, 작성자) 유지

### 12.2. 권한 검증
- [ ] 타인 메시지는 삭제 버튼 미표시
- [ ] 타인 메시지 삭제 시도 시 403 응답
- [ ] 이미 삭제된 메시지 재삭제 방지

### 12.3. 답장 관계
- [ ] 답장이 있는 메시지 삭제 가능
- [ ] 답장은 유지, 원본은 "삭제된 메시지" 표시
- [ ] 삭제된 메시지에 대한 답장 정상 표시

### 12.4. 데이터 보존
- [ ] is_deleted 플래그만 변경
- [ ] 메시지 내용(content) 보존
- [ ] 좋아요 데이터 유지

### 12.5. UX
- [ ] 낙관적 업데이트 즉시 반영
- [ ] 삭제 확인 다이얼로그 표시
- [ ] 네트워크 오류 시 롤백 및 재시도

---

## 13. 관련 문서

- [유저플로우 문서 - 8. 메시지 삭제](../userflow.md#8-메시지-삭제-유저플로우)
- [상태 관리 설계](../state-management.md)
- [데이터베이스 - messages 테이블](../database.md#4-messages-테이블)
- [Usecase 005 - 메시지 전송](./005_send_message.md)
- [Usecase 007 - 메시지 답장](./007_reply_message.md)
