# Usecase 007: 메시지 답장

**문서 번호:** UC-007
**기능명:** 메시지 답장
**작성일:** 2025-10-19
**관련 유저플로우:** 7. 메시지 답장 유저플로우

---

## 1. 개요

채팅방 참여자가 특정 메시지에 답장을 작성하는 기능입니다. 답장 대상 메시지를 선택하면 입력창 상단에 원본 메시지 미리보기가 표시되며, 전송된 답장 메시지는 원본 메시지와 시각적으로 연결되어 표시됩니다.

---

## 2. 사전 조건

- 사용자가 채팅방에 입장한 상태여야 합니다.
- 답장할 메시지가 존재해야 합니다.
- WebSocket 연결이 수립되어 있어야 합니다.

---

## 3. 액터

- **주 액터:** 채팅방 참여자
- **부 액터:** Cokaotalk 백엔드 시스템, 데이터베이스, WebSocket 서비스, 다른 참여자

---

## 4. 기본 시나리오 (정상 흐름)

### 4.1. 답장 버튼 클릭
1. 사용자가 메시지에 마우스를 올립니다.
2. 답장 버튼이 표시됩니다.
3. 사용자가 답장 버튼을 클릭합니다.

### 4.2. 답장 모드 활성화
4. 시스템이 답장 대상 메시지를 저장합니다.
5. 입력창 상단에 답장 대상 메시지 미리보기가 표시됩니다:
   - 원본 작성자 닉네임
   - 원본 메시지 내용 일부 (최대 50자, 말줄임)
   - 답장 취소 버튼 (X)
6. 입력창에 자동 포커스됩니다.

### 4.3. 답장 메시지 작성
7. 사용자가 답장 내용을 입력합니다.
8. 일반 메시지와 동일한 입력 처리가 적용됩니다.

### 4.4. 답장 전송
9. 사용자가 Enter 키 또는 전송 버튼을 클릭합니다.
10. 시스템이 메시지 객체를 생성합니다:
    ```typescript
    {
      content: "답장 내용",
      type: "text",
      parentMessageId: "원본-메시지-uuid"
    }
    ```

### 4.5. 서버 저장
11. 서버가 messages 테이블에 저장합니다:
    ```sql
    INSERT INTO messages (id, room_id, user_id, content, type, parent_message_id, created_at, updated_at)
    VALUES (gen_random_uuid(), $1, $2, $3, $4, $5, NOW(), NOW())
    RETURNING *;
    ```

### 4.6. WebSocket 브로드캐스트
12. 서버가 모든 참여자에게 답장 메시지를 브로드캐스트합니다:
    ```json
    {
      "type": "new_message",
      "payload": {
        "id": "msg-uuid",
        "content": "답장 내용",
        "type": "text",
        "authorId": "user-uuid",
        "authorNickname": "사용자닉네임",
        "parentMessageId": "원본-메시지-uuid",
        "parentMessage": {
          "id": "원본-메시지-uuid",
          "content": "원본 메시지 내용",
          "authorNickname": "원작성자"
        },
        "createdAt": "2025-10-19T12:00:00Z"
      }
    }
    ```

### 4.7. UI 렌더링
13. 답장 메시지가 원본 메시지와 연결되어 표시됩니다:
    - 답장 메시지 상단에 원본 메시지 인용 표시
    - 시각적 연결선 또는 들여쓰기
14. 입력창이 초기화되고 답장 모드가 해제됩니다.

---

## 5. 대체 시나리오 (예외 상황)

### 5.1. 답장 취소
- **조건:** 사용자가 답장 미리보기의 X 버튼 클릭
- **결과:**
  - 답장 모드 해제
  - 미리보기 영역 제거
  - 일반 메시지 모드로 복귀
- **복구:** 필요 시 답장 버튼 재클릭

### 5.2. ESC 키로 취소
- **조건:** 답장 모드에서 ESC 키 입력
- **결과:** 답장 모드 해제 (답장 취소와 동일)
- **복구:** 답장 버튼 재클릭

### 5.3. 원본 메시지 삭제됨
- **조건:** 답장 작성 중 원본 메시지가 삭제됨
- **결과:**
  - 답장은 가능 (전송됨)
  - 원본 메시지는 "삭제된 메시지" 로 표시
  - 답장 메시지에는 "삭제된 메시지에 대한 답장" 표시
- **복구:** 정상 동작

### 5.4. 답장의 답장
- **조건:** 이미 답장인 메시지에 다시 답장 시도
- **결과:**
  - 허용됨 (무한 체인 가능)
  - 원본 메시지는 최상위 원본이 아닌 바로 위 메시지
- **복구:** 정상 동작

### 5.5. 긴 원본 메시지
- **조건:** 원본 메시지가 100자 이상
- **결과:**
  - 미리보기에서 50자까지만 표시
  - "..." 말줄임 표시
  - 호버 시 전체 내용 툴팁 표시
- **복구:** 정상 동작

### 5.6. 네트워크 오류
- **조건:** 답장 전송 중 네트워크 오류
- **결과:**
  - 일반 메시지 전송 실패와 동일 처리
  - 재시도 옵션 제공
  - 답장 관계 유지
- **복구:** 재시도 시 parent_message_id 유지하여 전송

---

## 6. 사후 조건

### 성공 시
- messages 테이블에 parent_message_id가 설정된 답장 메시지가 저장됩니다.
- 모든 참여자 화면에 답장 메시지가 원본과 연결되어 표시됩니다.
- 답장 모드가 해제되고 입력창이 초기화됩니다.

### 실패 시
- 데이터베이스에 변경이 없습니다.
- 답장 모드는 유지됩니다 (재시도 가능).
- 사용자에게 오류 메시지가 표시됩니다.

---

## 7. 비기능적 요구사항

### 7.1. 성능
- 답장 모드 활성화: 즉시 (0ms)
- 답장 전송 응답 시간: 500ms 이내
- 원본 메시지 조회: 캐시 활용

### 7.2. 보안
- 답장 대상 메시지 존재 여부 검증
- 권한 검증 (채팅방 참여자만 가능)

### 7.3. 사용성
- 답장 취소 옵션 제공
- 원본 메시지 미리보기로 맥락 제공
- 시각적 연결로 대화 흐름 파악 용이

---

## 8. UI/UX 요구사항

### 8.1. 답장 버튼
- **위치:** 메시지 우측 또는 호버 시 표시
- **아이콘:** 답장 화살표 (↩️)

### 8.2. 답장 미리보기 (입력창 상단)
- **구성:**
  - 좌측: 세로 라인 (답장 표시)
  - 중앙: 원작성자 닉네임 + 원본 내용 일부
  - 우측: X 버튼 (취소)
- **배경색:** 밝은 회색
- **높이:** 최대 60px

### 8.3. 답장 메시지 표시
- **인용 영역:**
  - 답장 메시지 상단에 원본 메시지 축약 표시
  - 회색 배경, 작은 폰트
  - 클릭 시 원본 메시지로 스크롤 이동
- **연결선:**
  - 원본 메시지와 시각적 연결
  - 세로 라인 또는 들여쓰기

### 8.4. 삭제된 메시지 답장
- **표시:** "삭제된 메시지에 대한 답장"
- **스타일:** 회색, 이탤릭

---

## 9. 데이터베이스 영향

### 생성되는 레코드
```sql
{
  id: "reply-msg-uuid",
  room_id: "room-uuid",
  user_id: "user-uuid",
  content: "답장 내용",
  type: "text",
  parent_message_id: "원본-메시지-uuid",
  is_deleted: false,
  created_at: "2025-10-19T12:00:00Z",
  updated_at: "2025-10-19T12:00:00Z"
}
```

### 인덱스 활용
- `idx_messages_parent_message_id`: 답장 관계 조회

---

## 10. API 명세

### Endpoint
```
POST /api/rooms/:roomId/messages
```

### Request Body
```json
{
  "content": "답장 내용",
  "type": "text",
  "parentMessageId": "원본-메시지-uuid"
}
```

### Response (성공)
```json
{
  "success": true,
  "data": {
    "message": {
      "id": "reply-msg-uuid",
      "content": "답장 내용",
      "type": "text",
      "authorId": "user-uuid",
      "authorNickname": "사용자닉네임",
      "parentMessageId": "원본-메시지-uuid",
      "parentMessage": {
        "id": "원본-메시지-uuid",
        "content": "원본 메시지",
        "authorNickname": "원작성자",
        "isDeleted": false
      },
      "createdAt": "2025-10-19T12:00:00Z"
    }
  }
}
```

---

## 11. 상태 관리

### Context Actions
```typescript
// 답장 모드 활성화
actions.setReplyTarget(message);

// State 업데이트
input: {
  value: '',
  replyTarget: {
    id: "msg-uuid",
    content: "원본 메시지",
    authorNickname: "원작성자"
  },
  isComposing: false
}

// 답장 취소
actions.setReplyTarget(null);

// 답장 전송 (메시지 전송과 동일, parentMessageId 포함)
actions.sendMessage(content, 'text');
```

---

## 12. 테스트 시나리오

### 12.1. 정상 케이스
- [ ] 답장 버튼 클릭 시 답장 모드 활성화
- [ ] 답장 미리보기 정상 표시
- [ ] 답장 메시지 전송 성공
- [ ] 답장 메시지가 원본과 연결되어 표시

### 12.2. 답장 취소
- [ ] X 버튼으로 답장 취소
- [ ] ESC 키로 답장 취소
- [ ] 일반 메시지 모드로 복귀

### 12.3. 엣지 케이스
- [ ] 답장의 답장 가능
- [ ] 삭제된 메시지에 답장 가능 (삭제 표시)
- [ ] 긴 원본 메시지 말줄임 처리
- [ ] 자신의 메시지에도 답장 가능

### 12.4. UX
- [ ] 답장 클릭 시 입력창 자동 포커스
- [ ] 원본 메시지 클릭 시 스크롤 이동
- [ ] 시각적 연결선 표시

---

## 13. 관련 문서

- [유저플로우 문서 - 7. 메시지 답장](../userflow.md#7-메시지-답장-유저플로우)
- [상태 관리 설계](../state-management.md)
- [데이터베이스 - messages 테이블](../database.md#4-messages-테이블)
- [Usecase 005 - 메시지 전송](./005_send_message.md)
