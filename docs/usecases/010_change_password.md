# Usecase 010: 비밀번호 변경

**문서 번호:** UC-010
**기능명:** 비밀번호 변경
**작성일:** 2025-10-19
**관련 유저플로우:** 10. 비밀번호 변경 유저플로우

---

## 1. 개요

로그인한 사용자가 마이페이지에서 자신의 비밀번호를 변경하는 기능입니다. 보안을 위해 기존 비밀번호를 확인한 후 새 비밀번호로 변경하며, 변경 후 현재 세션은 유지됩니다.

---

## 2. 사전 조건

- 사용자가 로그인 상태여야 합니다 (JWT 토큰 유효).
- 마이페이지(/mypage)에 접근할 수 있어야 합니다.
- users 테이블이 정상적으로 구성되어 있어야 합니다.

---

## 3. 액터

- **주 액터:** 로그인된 사용자
- **부 액터:** Cokaotalk 백엔드 시스템, 데이터베이스

---

## 4. 기본 시나리오 (정상 흐름)

### 4.1. 비밀번호 변경 섹션 접근
1. 사용자가 마이페이지의 "비밀번호 변경" 섹션으로 이동합니다.
2. 다음 입력 필드가 표시됩니다:
   - 기존 비밀번호
   - 새 비밀번호
   - 새 비밀번호 재확인

### 4.2. 정보 입력
3. 사용자가 세 필드를 모두 입력합니다:
   - 기존 비밀번호: 현재 비밀번호
   - 새 비밀번호: 최소 8자 이상
   - 새 비밀번호 재확인: 새 비밀번호와 동일하게

### 4.3. 클라이언트 유효성 검증
4. 시스템이 실시간으로 검증합니다:
   - 새 비밀번호 길이 (8자 이상)
   - 새 비밀번호와 재확인 일치 여부
   - 기존 비밀번호와 새 비밀번호 다른지 확인

### 4.4. 저장 요청
5. 사용자가 "저장" 버튼을 클릭합니다.
6. 저장 버튼이 비활성화되어 중복 제출을 방지합니다.

### 4.5. 서버 검증
7. 서버가 다음을 수행합니다:
   - JWT 토큰에서 사용자 ID 추출
   - 데이터베이스에서 현재 password_hash 조회:
     ```sql
     SELECT password_hash FROM users WHERE id = $1;
     ```
   - bcrypt.compare()로 기존 비밀번호 확인
   - 새 비밀번호와 기존 비밀번호 동일 여부 확인

### 4.6. 비밀번호 해싱 및 저장
8. 서버가 새 비밀번호를 해싱합니다:
   ```typescript
   const newHash = await bcrypt.hash(newPassword, 10);
   ```
9. users 테이블을 업데이트합니다:
   ```sql
   UPDATE users
   SET password_hash = $1, updated_at = NOW()
   WHERE id = $2
   RETURNING id, email, nickname;
   ```

### 4.7. 성공 피드백
10. 서버가 성공 응답을 반환합니다.
11. 클라이언트가 "비밀번호가 변경되었습니다" 성공 메시지를 표시합니다.
12. 모든 입력 필드가 초기화됩니다.
13. 현재 세션은 유지됩니다 (재로그인 불필요).

---

## 5. 대체 시나리오 (예외 상황)

### 5.1. 필드 미입력
- **조건:** 세 필드 중 하나라도 비어있음
- **결과:** 해당 필드에 "필수 입력 항목입니다" 오류 메시지
- **복구:** 모든 필드 입력 후 재시도

### 5.2. 기존 비밀번호 불일치
- **조건:** bcrypt.compare() 결과가 false
- **결과:**
  - HTTP 401 Unauthorized 응답
  - "기존 비밀번호가 일치하지 않습니다" 오류 메시지
- **복구:** 올바른 기존 비밀번호 입력 후 재시도

### 5.3. 새 비밀번호 길이 부족
- **조건:** 새 비밀번호가 8자 미만
- **결과:** "비밀번호는 최소 8자 이상이어야 합니다" 오류 메시지
- **복구:** 8자 이상으로 수정

### 5.4. 새 비밀번호 불일치
- **조건:** 새 비밀번호와 재확인이 다름
- **결과:** "비밀번호가 일치하지 않습니다" 오류 메시지
- **복구:** 재확인 필드를 새 비밀번호와 동일하게 수정

### 5.5. 기존 비밀번호와 동일
- **조건:** 새 비밀번호가 기존 비밀번호와 같음
- **결과:**
  - HTTP 400 Bad Request 응답
  - "새 비밀번호는 기존 비밀번호와 달라야 합니다" 메시지
- **복구:** 다른 비밀번호 입력

### 5.6. 약한 비밀번호 (선택사항)
- **조건:** 비밀번호 강도가 약함 (예: "12345678")
- **결과:** 경고 메시지 "더 강력한 비밀번호를 권장합니다"
- **복구:** 무시하고 진행 가능하거나 강력한 비밀번호로 변경

### 5.7. 연속 시도 제한
- **조건:** 기존 비밀번호를 5회 이상 틀림
- **결과:**
  - 5분간 비밀번호 변경 차단
  - "비밀번호 변경 시도 횟수를 초과했습니다" 메시지
- **복구:** 5분 후 자동 해제

### 5.8. 네트워크 오류
- **조건:** 변경 요청 중 네트워크 끊김
- **결과:**
  - "네트워크 연결을 확인해주세요" 오류 메시지
  - 저장 버튼 재활성화
  - 입력값 유지 (보안 정보 제외)
- **복구:** 네트워크 확인 후 재입력 및 재시도

### 5.9. 서버 오류
- **조건:** 데이터베이스 업데이트 실패
- **결과:**
  - HTTP 500 응답
  - "일시적인 오류가 발생했습니다" 메시지
  - 저장 버튼 재활성화
- **복구:** 잠시 후 재시도

---

## 6. 사후 조건

### 성공 시
- users 테이블의 password_hash 필드가 새 비밀번호 해시로 업데이트됩니다.
- updated_at 타임스탬프가 갱신됩니다.
- 사용자는 다음 로그인부터 새 비밀번호를 사용합니다.
- 현재 세션은 유지됩니다.

### 실패 시
- users 테이블에 변경이 없습니다.
- 사용자는 기존 비밀번호로 계속 로그인할 수 있습니다.
- 입력 필드는 초기화되거나 유지됩니다 (보안 필드 제외).

---

## 7. 비기능적 요구사항

### 7.1. 성능
- 비밀번호 변경 처리 시간: 2초 이내
- bcrypt 해싱 시간: 500ms 이내

### 7.2. 보안
- bcrypt 솔트 라운드: 10 이상
- 기존 비밀번호 검증 필수
- 비밀번호는 평문으로 저장 금지
- HTTPS 필수 (평문 전송 금지)
- 연속 실패 제한 (5회, 5분 차단)

### 7.3. 사용성
- 비밀번호 표시/숨김 토글 제공
- 실시간 유효성 검증
- 명확한 성공/실패 피드백
- 입력 필드 자동 포커스

### 7.4. 접근성
- 모든 입력 필드에 label 연결
- 오류 메시지 스크린 리더 지원
- 키보드만으로 모든 기능 접근 가능

---

## 8. UI/UX 요구사항

### 8.1. 비밀번호 변경 섹션
- **제목:** "비밀번호 변경"
- **입력 필드:**
  1. 기존 비밀번호
  2. 새 비밀번호
  3. 새 비밀번호 재확인

### 8.2. 입력 필드
- **type:** password (표시/숨김 토글 포함)
- **autocomplete:**
  - 기존 비밀번호: current-password
  - 새 비밀번호: new-password
  - 재확인: new-password

### 8.3. 비밀번호 강도 표시 (선택사항)
- **위치:** 새 비밀번호 입력 필드 하단
- **표시:** 약함 / 보통 / 강함 (색상 및 프로그레스 바)

### 8.4. 저장 버튼
- **기본 상태:** 파란색 배경, "저장"
- **비활성 상태:** 회색 배경 (유효성 실패 시)
- **로딩 상태:** 스피너 + "저장 중..."

### 8.5. 피드백 메시지
- **성공:** 초록색 토스트 "비밀번호가 변경되었습니다"
- **오류:** 빨간색 인라인 메시지 (각 필드 하단)

---

## 9. 데이터베이스 영향

### 업데이트되는 레코드
```sql
-- Before
{
  id: "user-uuid",
  password_hash: "$2b$10$old_hash_here...",
  updated_at: "2025-10-19T12:00:00Z"
}

-- After
{
  id: "user-uuid",
  password_hash: "$2b$10$new_hash_here...",
  updated_at: "2025-10-19T12:10:00Z"
}
```

### 인덱스 활용
- 기본 키(id): 사용자 식별

---

## 10. API 명세

### Endpoint
```
PATCH /api/users/me/password
```

### Request Headers
```
Authorization: Bearer <JWT_TOKEN>
```

### Request Body
```json
{
  "currentPassword": "oldpassword123",
  "newPassword": "newpassword456",
  "newPasswordConfirm": "newpassword456"
}
```

### Response (성공)
```json
{
  "success": true,
  "message": "비밀번호가 변경되었습니다"
}
```

### Response (실패 - 기존 비밀번호 불일치)
```json
{
  "success": false,
  "error": {
    "code": "INVALID_PASSWORD",
    "message": "기존 비밀번호가 일치하지 않습니다"
  }
}
```

### Response (실패 - 유효성 검증)
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "비밀번호는 최소 8자 이상이어야 합니다",
    "details": {
      "field": "newPassword",
      "constraint": "minLength"
    }
  }
}
```

---

## 11. 테스트 시나리오

### 11.1. 정상 케이스
- [ ] 유효한 비밀번호로 변경 성공
- [ ] password_hash 필드 업데이트 확인
- [ ] 새 비밀번호로 로그인 가능
- [ ] 기존 비밀번호로 로그인 불가

### 11.2. 유효성 검증
- [ ] 기존 비밀번호 불일치 시 오류
- [ ] 새 비밀번호 8자 미만 시 오류
- [ ] 새 비밀번호 불일치 시 오류
- [ ] 기존 비밀번호와 동일 시 오류

### 11.3. 보안
- [ ] bcrypt로 해싱되어 저장
- [ ] 비밀번호 평문 저장 안 됨
- [ ] HTTPS를 통해서만 전송
- [ ] 연속 실패 5회 차단

### 11.4. UX
- [ ] 비밀번호 표시/숨김 토글
- [ ] 실시간 유효성 검증
- [ ] 성공 토스트 메시지
- [ ] 입력 필드 초기화

---

## 12. 관련 문서

- [유저플로우 문서 - 10. 비밀번호 변경](../userflow.md#10-비밀번호-변경-유저플로우)
- [데이터베이스 - users 테이블](../database.md#1-users-테이블)
- [PRD - 마이페이지 기능](../prd.md)
- [Usecase 001 - 회원가입](./001_signup.md)
- [Usecase 002 - 로그인](./002_login.md)
