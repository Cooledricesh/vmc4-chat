# 🔄 Cokaotalk 유저플로우 문서 (User Flow Document)

**프로젝트:** Cokaotalk MVP (v1.2)
**작성일:** 2025-10-19
**작성자:** 승현

---

## 📌 문서 개요

이 문서는 Cokaotalk MVP의 모든 기능별 유저플로우를 정의합니다. 각 플로우는 입력, 처리, 출력 단계로 구성되며, 발생 가능한 엣지케이스를 포함합니다.

---

## 1. 회원가입 유저플로우

### 입력
- 이메일 주소 입력
- 비밀번호 입력
- 비밀번호 확인 입력
- 닉네임 입력
- 회원가입 버튼 클릭

### 처리
1. 입력값 유효성 검증
   - 이메일 형식 검증
   - 비밀번호 최소 8자 이상 확인
   - 비밀번호와 비밀번호 확인 일치 여부 검증
   - 닉네임 길이 검증 (1-50자)
2. 서버 중복 검증
   - 이메일 중복 확인
   - 닉네임 중복 확인 (선택사항)
3. 비밀번호 해싱 (bcrypt)
4. 데이터베이스에 사용자 정보 저장
   - UUID 생성
   - 타임스탬프 기록

### 출력
- **성공 시**:
  - 회원가입 완료 메시지 표시
  - 로그인 페이지로 자동 리디렉션
- **실패 시**:
  - 이메일 중복: 이메일 중복 오류 메시지
  - 유효성 검증 실패: 해당 필드 하단 오류 메시지
  - 서버 오류: 일반 오류 메시지 및 재시도 안내

### 엣지케이스
- 네트워크 끊김: 로딩 상태 표시 후 타임아웃 오류
- 중복 제출 방지: 버튼 비활성화 처리
- SQL Injection 방지: 파라미터 바인딩

---

## 2. 로그인 유저플로우

### 입력
- 이메일 주소 입력
- 비밀번호 입력
- 로그인 버튼 클릭

### 처리
1. 입력값 기본 유효성 검증
   - 이메일 형식 확인
   - 비밀번호 입력 여부 확인
2. 데이터베이스에서 사용자 조회
   - 이메일로 사용자 검색
3. 비밀번호 검증
   - bcrypt compare로 해시값 비교
4. JWT 토큰 생성
   - 사용자 ID, 이메일, 닉네임 포함
   - 만료 시간 설정
5. HTTP-only 쿠키에 토큰 저장

### 출력
- **성공 시**:
  - 메인 페이지(/)로 즉시 리디렉션
  - 헤더에 사용자 정보 표시
- **실패 시**:
  - 이메일/비밀번호 불일치: "이메일 혹은 비밀번호를 확인해주세요." 메시지
  - 계정 미존재: 동일한 "이메일 혹은 비밀번호를 확인해주세요." 메시지
  - 서버 오류: 일반 오류 메시지

### 엣지케이스
- 이미 로그인된 상태: 메인 페이지로 자동 리디렉션
- 연속 로그인 실패: 일정 횟수 초과 시 일시적 차단 (옵션)
- 토큰 만료 처리: 자동 로그아웃 및 재로그인 유도
- CSRF 방지: CSRF 토큰 검증

---

## 3. 채팅방 만들기 유저플로우

### 입력
- 메인 페이지에서 채팅방 만들기 버튼 클릭
- 채팅방 이름 입력
- 생성 확인 버튼 클릭

### 처리
1. 사용자 인증 확인
   - JWT 토큰 유효성 검증
   - 로그인 상태 확인
2. 입력값 유효성 검증
   - 채팅방 이름 길이 검증 (1-100자)
   - 특수문자/이모지 모두 허용
3. 채팅방 데이터 생성
   - UUID 생성
   - creator_id에 현재 사용자 ID 설정
   - is_active를 true로 설정
   - 타임스탬프 기록
4. room_participants 테이블에 생성자 자동 추가
   - 방 생성자를 첫 번째 참여자로 등록
5. 채팅방 목록 정보 조합
   - 생성자 닉네임 조회
   - 생성 시간 포맷팅
6. 실시간 업데이트 트리거
   - WebSocket으로 채팅방 목록 갱신 브로드캐스트

### 출력
- **성공 시**:
  - 채팅방 목록에 새 방 즉시 표시 (방 이름, 생성자 닉네임, 생성 시간 포함)
  - 생성된 채팅방으로 자동 입장 (리디렉션)
  - 시스템 메시지로 방 생성 알림
- **실패 시**:
  - 이름 미입력: 필수 입력 안내 메시지
  - 서버 오류: 생성 실패 메시지 및 재시도 안내
  - 권한 없음: 로그인 페이지로 리디렉션

### 엣지케이스
- 같은 이름 방 생성: 허용 (생성자/시간으로 구분)
- 네트워크 끊김: 로딩 상태 표시 후 타임아웃
- 연속 생성 방지: 생성 버튼 일시 비활성화
- XSS 방지: 채팅방 이름 sanitization

---

## 4. 채팅방 입장 유저플로우

### 입력
- 메인 페이지의 채팅방 목록에서 특정 채팅방 클릭
- 또는 채팅방 URL 직접 접속 (/room/:id)

### 처리
1. 사용자 인증 확인
   - JWT 토큰 유효성 검증
   - 로그인 상태 확인
2. 채팅방 존재 여부 확인
   - room_id로 채팅방 조회
   - is_active 상태 확인
3. 참여자 등록 확인
   - room_participants에서 이미 참여 중인지 확인
   - 미참여 시 새로 등록
4. 채팅방 데이터 로드
   - 채팅방 정보 조회
   - 최근 메시지 히스토리 로드 (페이지네이션)
   - 참여자 목록 조회
5. WebSocket 연결 수립
   - 해당 채팅방 채널 구독
   - 실시간 메시지 수신 준비
6. 입장 알림 브로드캐스트
   - 시스템 메시지로 입장 알림 전송

### 출력
- **성공 시**:
  - 채팅방 페이지로 이동
  - 채팅 히스토리 표시
  - 입력창 활성화
  - 시스템 메시지로 본인 및 타인에게 입장 알림
- **실패 시**:
  - 채팅방 없음: 메인 페이지로 리디렉션 및 오류 메시지
  - 비활성 채팅방: 메인 페이지로 리디렉션
  - 권한 없음: 로그인 페이지로 리디렉션

### 엣지케이스
- WebSocket 연결 실패: 폴백으로 HTTP 폴링 시도
- 메시지 로드 실패: 기본 UI 표시 후 재시도 버튼
- 동시 입장: 중복 입장 메시지 방지
- 네트워크 재연결: 자동 재구독 처리

---

## 5. 메시지 전송 유저플로우

### 입력
- 채팅방 입력창에 텍스트 입력
- Enter 키 또는 전송 버튼 클릭
- 또는 이모지 버튼 클릭 후 이모지 선택

### 처리
1. 입력 전처리
   - 공백만 있는 메시지 필터링
   - 메시지 길이 검증
   - 한글 IME 상태 확인 (compositionend 대기)
2. 메시지 객체 생성
   - UUID 생성
   - user_id, room_id 설정
   - content 및 type(text/emoji) 설정
   - 타임스탬프 기록
3. 메시지 저장
   - 데이터베이스에 메시지 저장
   - is_deleted를 false로 설정
4. WebSocket 브로드캐스트
   - 같은 채팅방 모든 참여자에게 전송
   - 발신자 정보 포함 (닉네임, ID)
5. 입력창 처리
   - 입력창 내용 초기화
   - 포커스 유지

### 출력
- **성공 시**:
  - 메시지 즉시 화면 표시 (낙관적 업데이트)
  - 다른 참여자 화면에 실시간 표시
  - 입력창 초기화 및 포커스 유지
  - 최하단 자동 스크롤
- **실패 시**:
  - 전송 실패 아이콘 표시
  - 재전송 옵션 제공
  - 메시지 로컬 보관 (임시)

### 엣지케이스
- 한글 조합 중 Enter: 전송 방지 후 조합 완료 대기
- WebSocket 끊김: 큐에 저장 후 재연결 시 전송
- 메시지 중복: 클라이언트 측 ID로 중복 방지
- 긴 메시지: 자동 줄바꿈 및 스크롤
- Shift+Enter: 줄바꿈 처리 (전송하지 않음)

---

## 6. 메시지 좋아요 유저플로우

### 입력
- 채팅방 내 다른 사용자의 메시지에 마우스 호버
- 좋아요 버튼/아이콘 클릭

### 처리
1. 사용자 권한 확인
   - 로그인 상태 확인
   - 채팅방 참여자 여부 확인
   - 자신의 메시지인지 확인 (자신의 메시지면 차단)
2. 기존 반응 확인
   - message_reactions 테이블에서 중복 체크
   - 이미 좋아요한 경우 취소 처리
3. 반응 토글 처리
   - 좋아요 추가: 새 레코드 생성
   - 좋아요 취소: 기존 레코드 삭제
4. 카운트 업데이트
   - 해당 메시지의 총 좋아요 수 재계산
5. WebSocket 브로드캐스트
   - 실시간으로 모든 참여자에게 업데이트 전송

### 출력
- **성공 시**:
  - 좋아요 아이콘 즉시 활성화/비활성화 (낙관적 업데이트)
  - 좋아요 카운트 실시간 업데이트
  - 다른 참여자 화면에도 실시간 반영
- **실패 시**:
  - 자신의 메시지: 아무 동작 없음
  - UI 원상복구 (롤백)
  - 오류 메시지 표시 (토스트)
  - 재시도 옵션 제공

### 엣지케이스
- 동시 토글: 마지막 액션 기준으로 처리
- 삭제된 메시지: 좋아요 불가 처리
- 네트워크 끊김: 로컬 상태 유지 후 동기화
- 연속 클릭 방지: 디바운싱 적용

---

## 7. 메시지 답장 유저플로우

### 입력
- 채팅방 내 특정 메시지에 마우스 호버
- 답장 버튼/아이콘 클릭

### 처리
1. 답장 대상 설정
   - 원본 메시지 ID 저장
   - 원본 메시지 정보 조회 (작성자, 내용 일부)
2. UI 상태 변경
   - 입력창 상단에 답장 대상 표시
   - 답장 취소 버튼 활성화
   - 입력창 자동 포커스
3. 답장 메시지 작성
   - 일반 메시지와 동일한 입력 처리
   - parent_message_id 필드에 원본 메시지 ID 설정
4. 답장 메시지 저장
   - messages 테이블에 저장
   - parent_message_id로 관계 설정
5. WebSocket 브로드캐스트
   - 답장 메시지와 원본 메시지 정보 함께 전송

### 출력
- **성공 시**:
  - 입력창 상단에 답장 대상 메시지 미리보기 표시
  - 답장 메시지 전송 시 원본 메시지와 연결 표시 (인용 형태)
  - 답장 취소 시 일반 메시지 모드로 복귀
  - 다른 참여자에게도 답장 관계 표시
- **실패 시**:
  - 삭제된 메시지: 답장 불가 안내
  - 전송 실패: 재시도 옵션 제공
  - 원본 메시지 로드 실패: 답장 모드 자동 취소

### 엣지케이스
- 답장 중 원본 메시지 삭제: 답장은 가능하나 "삭제된 메시지" 표시
- 답장의 답장: 허용 (무한 체인 가능)
- 자신의 메시지 답장: 허용
- 답장 모드에서 ESC 키: 답장 취소
- 긴 원본 메시지: 미리보기 텍스트 말줄임 처리

---

## 8. 메시지 삭제 유저플로우

### 입력
- 자신이 작성한 메시지에 마우스 호버
- 삭제 버튼/아이콘 클릭
- 삭제 확인 (선택사항)

### 처리
1. 권한 검증
   - 로그인 상태 확인
   - 메시지 작성자 본인 확인
   - 채팅방 참여자 여부 확인
2. 삭제 처리 방식 결정
   - Soft delete: is_deleted를 true로 변경
   - 메시지 내용은 보존 (감사 목적)
3. 데이터베이스 업데이트
   - is_deleted 플래그 true로 설정
   - updated_at 타임스탬프 갱신
4. 관련 데이터 처리
   - 답장 관계는 유지 (원본 삭제 표시)
   - 좋아요 데이터는 유지
5. WebSocket 브로드캐스트
   - 모든 참여자에게 삭제 상태 전송

### 출력
- **성공 시**:
  - 메시지 즉시 "삭제된 메시지" 텍스트로 대체
  - 메시지 구조는 유지 (시간, 작성자 표시)
  - 답장 연결선은 유지
  - 다른 참여자 화면에도 실시간 반영
- **실패 시**:
  - 권한 없음: 삭제 버튼 미표시
  - 서버 오류: 삭제 실패 메시지
  - 네트워크 오류: 재시도 옵션

### 엣지케이스
- 답장이 있는 메시지 삭제: 답장은 유지, 원본은 "삭제된 메시지" 표시
- 이미 삭제된 메시지: 중복 삭제 방지
- 삭제 중 네트워크 끊김: 로컬 상태 롤백
- 타인 메시지 삭제 시도: 권한 오류
- 삭제 후 복구: MVP에서는 미지원

---

## 9. 닉네임 변경 유저플로우

### 입력
- 마이페이지 접속
- 닉네임 변경 섹션에서 새 닉네임 입력
- 저장 버튼 클릭

### 처리
1. 사용자 인증 확인
   - JWT 토큰 유효성 검증
   - 로그인 상태 확인
2. 입력값 유효성 검증
   - 닉네임 길이 확인 (1-50자)
   - 특수문자/이모지 허용
   - 현재 닉네임과 동일한지 확인
3. 중복 확인 (선택사항)
   - 닉네임 유니크 제약이 있을 경우 확인
   - MVP에서는 중복 허용 가능
4. 데이터베이스 업데이트
   - users 테이블의 nickname 필드 갱신
   - updated_at 타임스탬프 갱신
5. JWT 토큰 갱신
   - 새 닉네임을 포함한 토큰 재발급
   - HTTP-only 쿠키 업데이트
6. 전역 상태 업데이트
   - 헤더의 사용자 정보 갱신
   - 활성 채팅방이 있을 경우 닉네임 반영

### 출력
- **성공 시**:
  - 성공 메시지 표시 (토스트/인라인)
  - 현재 닉네임 표시 영역 즉시 갱신
  - 헤더 및 전역 UI 닉네임 업데이트
  - 입력 필드 초기화
- **실패 시**:
  - 유효성 검증 실패: 필드 하단 오류 메시지
  - 서버 오류: 변경 실패 메시지
  - 인증 만료: 로그인 페이지로 리디렉션

### 엣지케이스
- 동일한 닉네임 재입력: 변경 없음 안내
- 빈 닉네임 시도: 필수 입력 안내
- 변경 중 로그아웃: 작업 취소
- 채팅방 내 기존 메시지: 이전 닉네임 유지 (히스토리 보존)
- 연속 변경 방지: 저장 버튼 일시 비활성화

---

## 10. 비밀번호 변경 유저플로우

### 입력
- 마이페이지 접속
- 비밀번호 변경 섹션 진입
- 기존 비밀번호 입력
- 새 비밀번호 입력
- 새 비밀번호 재확인 입력
- 저장 버튼 클릭

### 처리
1. 사용자 인증 확인
   - JWT 토큰 유효성 검증
   - 로그인 상태 확인
2. 기존 비밀번호 검증
   - 데이터베이스에서 현재 비밀번호 해시 조회
   - bcrypt compare로 일치 여부 확인
3. 새 비밀번호 유효성 검증
   - 최소 8자 이상 확인
   - 새 비밀번호와 재확인 일치 확인
   - 기존 비밀번호와 동일한지 확인
4. 새 비밀번호 해싱
   - bcrypt로 새 비밀번호 해싱
5. 데이터베이스 업데이트
   - users 테이블의 password_hash 갱신
   - updated_at 타임스탬프 갱신
6. 보안 처리
   - 모든 기기에서 재로그인 유도 (선택사항)
   - 비밀번호 변경 이메일 알림 (선택사항)

### 출력
- **성공 시**:
  - 성공 메시지 표시
  - 모든 입력 필드 초기화
  - 현재 세션 유지 또는 재로그인 요청
- **실패 시**:
  - 기존 비밀번호 불일치: 인증 실패 메시지
  - 새 비밀번호 불일치: 비밀번호 재확인 오류
  - 유효성 검증 실패: 요구사항 안내 메시지
  - 서버 오류: 변경 실패 메시지

### 엣지케이스
- 동일한 비밀번호로 변경 시도: 다른 비밀번호 사용 안내
- 비밀번호 강도 검증: 약한 비밀번호 경고
- 연속 시도 제한: 일정 횟수 실패 시 일시 차단
- 변경 중 로그아웃: 작업 취소
- 입력 중 세션 만료: 재인증 요구

---

## 11. 로그아웃 유저플로우

### 입력
- 메인 페이지 또는 마이페이지에서 로그아웃 버튼 클릭
- 로그아웃 확인 (선택사항)

### 처리
1. 사용자 확인
   - 현재 로그인 상태 확인
   - 활성 세션 정보 조회
2. 클라이언트 측 정리
   - 로컬 스토리지/세션 스토리지 초기화
   - 전역 상태(Zustand) 초기화
   - WebSocket 연결 종료
   - React Query 캐시 초기화
3. 서버 측 처리
   - JWT 토큰 무효화
   - HTTP-only 쿠키 삭제
   - 활성 세션 종료
4. 채팅방 처리
   - 참여 중인 채팅방에서 퇴장 처리
   - 퇴장 시스템 메시지 브로드캐스트

### 출력
- **성공 시**:
  - 로그인 페이지로 즉시 리디렉션
  - 모든 인증 상태 초기화
  - 채팅방에서 퇴장 알림 표시 (다른 사용자에게)
- **실패 시**:
  - 네트워크 오류: 강제 로컬 로그아웃 진행
  - 서버 오류: 로컬 정리 후 로그인 페이지로 이동

### 엣지케이스
- 이미 로그아웃 상태: 로그인 페이지로 리디렉션
- 채팅 중 로그아웃: 메시지 전송 중단 및 정리
- 네트워크 끊김: 로컬 로그아웃 처리
- 다중 탭/창: 모든 탭에서 동시 로그아웃
- 자동 로그아웃: 세션 만료 시 동일 처리

---

## 12. 비로그인 접근 제한 유저플로우

### 입력
- 비로그인 상태에서 보호된 페이지 접근 시도
  - 메인 페이지(/)
  - 채팅방 페이지(/room/:id)
  - 마이페이지(/mypage)
- URL 직접 입력 또는 북마크 접속

### 처리
1. 라우트 가드 확인
   - 페이지 진입 전 인증 상태 확인
   - JWT 토큰 존재 여부 검증
   - 토큰 유효성 검증
2. 인증 상태 판별
   - 토큰 없음: 미인증 상태
   - 토큰 만료: 만료된 세션
   - 토큰 무효: 변조된 토큰
3. 리디렉션 처리
   - 원래 요청한 URL 저장
   - 로그인 페이지로 리디렉션
   - 리디렉션 파라미터 전달 (선택사항)
4. 세션 복구 시도
   - 리프레시 토큰 확인 (있을 경우)
   - 자동 재인증 시도 (선택사항)

### 출력
- **비로그인 시**:
  - 로그인 페이지로 자동 리디렉션
  - 접근 제한 안내 메시지 (선택사항)
  - 원래 URL 저장 (로그인 후 복귀용)
- **토큰 만료 시**:
  - 세션 만료 안내 메시지
  - 로그인 페이지로 리디렉션
  - 이전 입력 정보 유지 (선택사항)
- **토큰 무효 시**:
  - 보안 경고 메시지 (선택사항)
  - 로그인 페이지로 리디렉션
  - 모든 로컬 데이터 초기화

### 엣지케이스
- 로그인 중 만료: 작업 중단 및 재인증 요구
- 다중 탭 동시 접근: 모든 탭에서 일관된 처리
- 새로고침 시: 동일한 접근 제한 적용
- 뒤로가기/앞으로가기: 히스토리 스택 정리
- API 요청 중 인증 실패: 요청 중단 및 리디렉션

---

## 📝 문서 이력

| 버전 | 날짜 | 변경 내용 | 작성자 |
|-----|------|----------|--------|
| v1.0 | 2025-10-19 | 초기 유저플로우 문서 작성 | 승현 |

---

## 🔗 관련 문서

- [Product Requirement Document (PRD)](./prd.md)
- [기술 스택 문서](./tech-stack.md)
- [API 명세서](./api-spec.md)