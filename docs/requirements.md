# 📋 채팅방 페이지 구현 요구사항 (Requirements Document)

**프로젝트:** Cokaotalk MVP - 채팅방 페이지
**작성일:** 2025-10-19
**작성자:** 승현
**문서 버전:** v1.0

---

## 📌 개요

이 문서는 Cokaotalk MVP의 채팅방 페이지(/room/:id) 구현을 위한 상세 요구사항을 정의합니다.
PRD와 Userflow 문서를 기반으로 작성되었으며, 개발 시 체크리스트로 활용됩니다.

---

## ✅ 기능별 요구사항

### 1. 페이지 접근 및 인증

#### 1.1 접근 제어
- [ ] 로그인 상태 검증 (JWT 토큰 확인)
- [ ] 비로그인 시 로그인 페이지로 자동 리디렉션
- [ ] 리디렉션 시 원래 채팅방 URL 저장 (로그인 후 복귀용)

#### 1.2 채팅방 유효성 검증
- [ ] 채팅방 존재 여부 확인 (room_id 검증)
- [ ] 채팅방 활성화 상태 확인 (is_active)
- [ ] 존재하지 않거나 비활성 채팅방 접근 시 메인 페이지로 리디렉션

#### 1.3 참여자 관리
- [ ] 첫 입장 시 room_participants 테이블에 자동 등록
- [ ] 재입장 시 중복 등록 방지
- [ ] 입장 시 시스템 메시지 브로드캐스트

---

### 2. UI/UX 구성

#### 2.1 페이지 레이아웃
```
┌─────────────────────────────────────┐
│  [←] 채팅방 이름 (참여자 N명)  [마이페이지] │  <- 헤더
├─────────────────────────────────────┤
│                                     │
│         메시지 리스트 영역              │  <- 메시지 영역
│                                     │
├─────────────────────────────────────┤
│  [답장 대상 미리보기]                   │  <- 답장 모드 (조건부)
├─────────────────────────────────────┤
│  [😊] [입력창...] [전송]              │  <- 입력 영역
└─────────────────────────────────────┘
```

#### 2.2 헤더 영역
- [ ] 뒤로가기 버튼 (메인페이지로 이동)
- [ ] 채팅방 이름 표시
- [ ] 실시간 참여자 수 표시
- [ ] 마이페이지 버튼

#### 2.3 메시지 리스트 영역
- [ ] 메시지 타입별 렌더링
  - [ ] 텍스트 메시지
  - [ ] 이모지 메시지
  - [ ] 시스템 메시지 (입장/퇴장)
  - [ ] 삭제된 메시지 표시
- [ ] 메시지별 정보 표시
  - [ ] 작성자 닉네임
  - [ ] 작성 시간
  - [ ] 좋아요 카운트
  - [ ] 답장 관계 표시 (원본 메시지 연결)
- [ ] 시간 그룹핑 (1분 내 연속 메시지)
- [ ] 무한 스크롤 페이지네이션

#### 2.4 입력 영역
- [ ] 멀티라인 텍스트 입력 (자동 높이 조절, 최대 5줄)
- [ ] 이모지 피커 버튼 및 팝업
- [ ] 전송 버튼
- [ ] 답장 모드 시 원본 메시지 미리보기
- [ ] 답장 취소 버튼 (답장 모드)

---

### 3. 메시지 전송 기능

#### 3.1 입력 처리
- [ ] Enter 키: 메시지 전송
- [ ] Shift + Enter: 줄바꿈
- [ ] 한글 IME 조합 처리 (compositionend 이벤트)
- [ ] 공백만 있는 메시지 필터링
- [ ] 메시지 길이 제한 검증
- [ ] 전송 후 입력창 초기화
- [ ] 전송 후 포커스 유지

#### 3.2 메시지 저장 및 동기화
- [ ] UUID 생성
- [ ] 데이터베이스 저장 (messages 테이블)
- [ ] WebSocket 브로드캐스트
- [ ] 낙관적 업데이트 (즉시 화면 반영)
- [ ] 전송 실패 시 재전송 옵션
- [ ] 메시지 중복 방지 (클라이언트 ID)

#### 3.3 스크롤 동작
- [ ] 새 메시지 전송 시 최하단 자동 스크롤
- [ ] 새 메시지 수신 시 자동 스크롤 (조건부)
- [ ] 이전 메시지 읽는 중일 때 스크롤 위치 유지

---

### 4. 메시지 상호작용 기능

#### 4.1 좋아요 기능
- [ ] 호버 시 좋아요 버튼 표시
- [ ] 본인 메시지 좋아요 차단
- [ ] 좋아요 토글 (추가/취소)
- [ ] 좋아요 카운트 실시간 업데이트
- [ ] 낙관적 업데이트
- [ ] 연속 클릭 방지 (디바운싱)
- [ ] 삭제된 메시지 좋아요 차단

#### 4.2 답장 기능
- [ ] 호버 시 답장 버튼 표시
- [ ] 답장 모드 활성화
- [ ] 입력창 상단에 원본 메시지 미리보기
- [ ] 답장 취소 (버튼 또는 ESC 키)
- [ ] parent_message_id 관계 설정
- [ ] 답장 메시지 인용 표시
- [ ] 답장의 답장 허용
- [ ] 삭제된 메시지 답장 (원본은 "삭제된 메시지"로 표시)

#### 4.3 삭제 기능
- [ ] 호버 시 삭제 버튼 표시 (본인 메시지만)
- [ ] 삭제 확인 (선택사항)
- [ ] Soft delete (is_deleted = true)
- [ ] "삭제된 메시지" 텍스트로 대체
- [ ] 메시지 구조 유지 (시간, 작성자)
- [ ] 답장 관계 유지
- [ ] 실시간 동기화

---

### 5. 실시간 통신 (WebSocket)

#### 5.1 연결 관리
- [ ] 페이지 진입 시 WebSocket 연결
- [ ] 채팅방 채널 구독
- [ ] 연결 상태 모니터링
- [ ] 재연결 자동 시도
- [ ] 연결 실패 시 폴백 처리

#### 5.2 이벤트 처리
- [ ] 새 메시지 수신
- [ ] 메시지 삭제 이벤트
- [ ] 좋아요 업데이트
- [ ] 입장/퇴장 시스템 메시지
- [ ] 참여자 수 변경

#### 5.3 오프라인 동기화
- [ ] 네트워크 끊김 시 메시지 큐 저장
- [ ] 재연결 시 큐 메시지 전송
- [ ] 동기화 상태 표시

---

### 6. 성능 최적화

#### 6.1 메시지 로딩
- [ ] 초기 로드: 최근 50개 메시지
- [ ] 무한 스크롤로 이전 메시지 로드
- [ ] 메시지 캐싱 (React Query)
- [ ] 이미지/이모지 레이지 로딩

#### 6.2 렌더링 최적화
- [ ] 가상 스크롤 (큰 메시지 리스트)
- [ ] 메시지 컴포넌트 메모이제이션
- [ ] 디바운싱/쓰로틀링 적용

---

### 7. 에러 처리

#### 7.1 네트워크 에러
- [ ] WebSocket 연결 실패 처리
- [ ] API 요청 실패 시 재시도
- [ ] 타임아웃 처리
- [ ] 오프라인 모드 감지

#### 7.2 유효성 에러
- [ ] 채팅방 없음/비활성 처리
- [ ] 권한 없음 처리
- [ ] 세션 만료 처리

#### 7.3 사용자 피드백
- [ ] 로딩 상태 표시
- [ ] 에러 토스트 메시지
- [ ] 재시도 옵션 제공
- [ ] 에러 바운더리 구현

---

### 8. 보안 요구사항

#### 8.1 입력 검증
- [ ] XSS 방지 (메시지 sanitization)
- [ ] SQL Injection 방지
- [ ] 메시지 길이 제한
- [ ] 파일 업로드 제한 (향후)

#### 8.2 인증/인가
- [ ] JWT 토큰 검증
- [ ] 채팅방 참여자 권한 확인
- [ ] 메시지 작성자 검증
- [ ] CSRF 보호

---

### 9. 접근성 요구사항

#### 9.1 키보드 네비게이션
- [ ] Tab 키로 요소 간 이동
- [ ] Enter/Space로 버튼 동작
- [ ] ESC로 모달/팝업 닫기

#### 9.2 스크린 리더 지원
- [ ] ARIA 레이블 적용
- [ ] 시멘틱 HTML 사용
- [ ] 역할(role) 속성 정의

#### 9.3 시각적 피드백
- [ ] 포커스 인디케이터
- [ ] 호버 상태
- [ ] 활성 상태
- [ ] 로딩 상태

---

### 10. 모바일 대응

#### 10.1 반응형 디자인
- [ ] 모바일 레이아웃 최적화
- [ ] 터치 제스처 지원
- [ ] 가상 키보드 대응

#### 10.2 모바일 UX
- [ ] 터치 영역 최소 44x44px
- [ ] 스와이프 제스처 (선택사항)
- [ ] Pull-to-refresh (선택사항)

---

## 📊 데이터베이스 스키마 요구사항

### messages 테이블
```sql
- id (UUID, PRIMARY KEY)
- room_id (UUID, FOREIGN KEY)
- user_id (UUID, FOREIGN KEY)
- content (TEXT, NOT NULL)
- type (VARCHAR(20), DEFAULT 'text')
- parent_message_id (UUID, FOREIGN KEY, NULL)
- is_deleted (BOOLEAN, DEFAULT false)
- created_at (TIMESTAMP)
- updated_at (TIMESTAMP)
```

### message_reactions 테이블
```sql
- id (UUID, PRIMARY KEY)
- message_id (UUID, FOREIGN KEY)
- user_id (UUID, FOREIGN KEY)
- reaction_type (VARCHAR(20), DEFAULT 'like')
- created_at (TIMESTAMP)
```

### room_participants 테이블
```sql
- id (UUID, PRIMARY KEY)
- room_id (UUID, FOREIGN KEY)
- user_id (UUID, FOREIGN KEY)
- joined_at (TIMESTAMP)
- UNIQUE(room_id, user_id)
```

---

## 🧪 테스트 요구사항

### 단위 테스트
- [ ] 메시지 전송 로직
- [ ] 한글 IME 처리
- [ ] 메시지 유효성 검증
- [ ] 좋아요/답장/삭제 로직

### 통합 테스트
- [ ] WebSocket 연결 및 메시지 동기화
- [ ] 인증 플로우
- [ ] 에러 처리 시나리오

### E2E 테스트
- [ ] 전체 채팅 플로우
- [ ] 다중 사용자 시나리오
- [ ] 네트워크 장애 복구

---

## 📈 성능 목표

- 페이지 로드: < 2초
- 메시지 전송 지연: < 100ms
- 동시 접속자: 최소 100명
- 메시지 렌더링: 1000개 메시지까지 버벅임 없음
- WebSocket 재연결: < 3초

---

## 🔄 향후 개선사항 (Post-MVP)

- [ ] 파일 업로드 (이미지, 문서)
- [ ] 메시지 검색
- [ ] 메시지 수정
- [ ] 읽음 표시
- [ ] 타이핑 인디케이터
- [ ] 푸시 알림
- [ ] 메시지 암호화
- [ ] 음성/영상 통화
- [ ] 채팅방 설정 (공지, 권한 관리)
- [ ] 메시지 신고/차단

---

## 📝 문서 이력

| 버전 | 날짜 | 변경 내용 | 작성자 |
|-----|------|----------|--------|
| v1.0 | 2025-10-19 | 초기 요구사항 정의 | 승현 |

---

## 🔗 참고 문서

- [Product Requirement Document (PRD)](./prd.md)
- [User Flow Document](./userflow.md)
- [Database Schema](./database.md)
- [API Specification](./api-spec.md)